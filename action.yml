name: 'PR Changes Requested Labeler'
description: 'Automatically labels pull requests when any reviewer requests changes'

branding:
  icon: 'tag'
  color: 'orange'

runs:
  using: 'composite'
  steps:
    - name: Add label when changes requested
      if: github.event.review.state == 'changes_requested'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            labels: ['changes-requested']
          });

          console.log(`Label 'changes-requested' added to PR #${context.payload.pull_request.number}`);

    - name: Convert PR to Draft on changes requested
      if: github.event.review.state == 'changes_requested' && github.event.pull_request.draft == false
      uses: actions/github-script@v7
      with:
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          const pull_number = context.payload.pull_request.number;
          await github.request('POST /repos/{owner}/{repo}/pulls/{pull_number}/convert_to_draft', {
            owner,
            repo,
            pull_number
          });

    - name: Post workflow trigger comment
      if: |
        github.event_name == 'pull_request' && (
          github.event.action == 'ready_for_review' ||
          (
            (github.event.action == 'opened' || github.event.action == 'reopened') &&
            github.event.pull_request.draft == false
          )
        )
        
      uses: actions/github-script@v7
      with:
        script: |
          const owner = context.repo.owner;
          const repo  = context.repo.repo;
          const prNumber = context.payload.pull_request.number;
          const branch   = context.payload.pull_request.head.ref;
          const ref      = context.payload.pull_request.head.sha;

          const workflows = await github.rest.actions.listRepoWorkflows({ owner, repo });

          const lines = workflows.data.workflows
            .filter(w => !w.name.toLowerCase().includes('label'))
              .map(w => {
                const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${w.id}/dispatches`;
                const curl = [
                  `**${w.name}**`,
                  '```bash',
                  `curl -X POST \\`,
                  `  -H "Accept: application/vnd.github+json" \\`,
                  `  -H "Authorization: Bearer $GITHUB_TOKEN" \\`,
                  `  ${url} \\`,
                  `  -d '{"ref":"${branch}"}'`,
                  '```',
                ].join('\n');
                return curl;
              })
              .join('\n\n---\n\n');

            const body = [
              ' Manual Workflow Triggers',
              '',
              `> Branch: \`${branch}\`  |  Commit: \`${ref.substring(0, 7)}\``,
              '',
              'Use these commands to trigger workflows on demand:',
              '',
              lines,
            ].join('\n');

            const comments = await github.rest.issues.listComments({
              owner, repo, issue_number: prNumber,
            });
            const existing = comments.data.find(
              c => c.user.type === 'Bot' && c.body.includes('Manual Workflow Triggers')
            );

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });
            }